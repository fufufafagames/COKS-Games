<%- include('../layouts/header', { title: title }) %>
<%- include('../partials/navbar') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="form-card">
        <div class="text-center mb-4">
          <i class="fas fa-upload fa-3x text-aqua"></i>
          <h2 class="mt-3">Upload Your Game</h2>
          <p class="text-white">Share your game with the community</p>
        </div>

        <form id="game-form" action="/games" method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="title" class="form-label">
              <i class="fas fa-heading"></i> Game Title *
            </label>
            <input
              type="text"
              class="form-control"
              id="title"
              name="title"
              required
              minlength="3"
              maxlength="255"
            />
            <small class="text-white">Enter a catchy title for your game</small>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">
              <i class="fas fa-align-left"></i> Description *
            </label>
            <textarea
              class="form-control"
              id="description"
              name="description"
              rows="5"
              required
              minlength="50"
            ></textarea>
            <small class="text-white"
              >Minimum 50 characters. Describe your game, gameplay, controls,
              etc.</small
            >
          </div>

          <!-- Game Mode Section -->
          <div class="mb-4">
              <label class="form-label d-block text-white mb-3">
                  <i class="fas fa-gamepad"></i> Game Mode *
              </label>
              <div class="row">
                  <div class="col-md-6 mb-2">
                       <input type="radio" class="btn-check" name="game_mode" id="mode_play" value="play" checked autocomplete="off">
                       <label class="btn btn-outline-aqua w-100 p-3" for="mode_play">
                           <i class="fas fa-globe fa-2x mb-2"></i><br>
                           <strong>Play (Browser)</strong><br>
                           <small>Playable directly in browser via iframe</small>
                       </label>
                  </div>
                  <div class="col-md-6 mb-2">
                       <input type="radio" class="btn-check" name="game_mode" id="mode_download" value="download" autocomplete="off">
                       <label class="btn btn-outline-info w-100 p-3" for="mode_download">
                           <i class="fas fa-download fa-2x mb-2"></i><br>
                           <strong>Download (PC)</strong><br>
                           <small>Users download files to play locally</small>
                       </label>
                  </div>
              </div>
          </div>

          <!-- GitHub URL (Always Visible, Optional) -->
          <div class="mb-3">
            <label for="github_url" class="form-label">
              <i class="fab fa-github"></i> GitHub URL Reference (Optional)
            </label>
            <input
              type="url"
              class="form-control"
              id="github_url"
              name="github_url"
              placeholder="https://github.com/username/repo (For Browser Games)"
            />
            <small class="text-white-50">
              Required for "Play" mode to load game. Optional for "Download" mode.
            </small>
          </div>

          <!-- Download Configuration (Shown only for Download Mode) -->
          <div id="download-config-section" class="download-config-modern p-4 mb-4 animate-fade-in" style="display: none;">
              <div class="download-config-header d-flex align-items-center gap-2">
                  <i class="fas fa-cogs fa-lg text-aqua"></i>
                  <h5 class="text-aqua mb-0 fw-bold header-title">Download Configuration</h5>
              </div>
              
              <div class="row mb-4">
                  <div class="col-md-3">
                      <label class="modern-label">Version</label>
                      <input type="text" name="version" class="form-control form-control-modern" placeholder="e.g. v1.0">
                  </div>
                  <div class="col-md-3">
                      <label class="modern-label">OS Platform</label>
                      <select name="os" class="form-select form-select-modern">
                          <option value="Windows">Windows</option>
                          <option value="Linux">Linux</option>
                          <option value="Mac">Mac</option>
                          <option value="Android">Android</option>
                          <option value="Multi-Platform">Multi-Platform</option>
                      </select>
                  </div>
                  <div class="col-md-3">
                      <label class="modern-label">Install Type</label>
                      <select name="install_type" class="form-select form-select-modern">
                          <option value="Installer (.exe)">Installer (.exe)</option>
                          <option value="Portable (.zip)">Portable (.zip)</option>
                          <option value="ISO Image">ISO Image</option>
                          <option value="APK">APK</option>
                      </select>
                  </div>
                  <div class="col-md-3">
                      <label class="modern-label">File Size</label>
                      <input type="text" name="file_size" class="form-control form-control-modern" placeholder="e.g. 2 GB">
                  </div>
              </div>

              <!-- Download Links Manager -->
              <div class="mb-3">
                  <label class="modern-label mb-3"><i class="fas fa-link me-1"></i> Download Mirrors</label>
                  <div id="links-container" class="d-grid gap-2">
                      <!-- Dynamic Rows will be added here -->
                      <div class="row link-row g-2 align-items-center">
                          <div class="col-4 col-md-3">
                              <input type="text" name="provider_name[]" class="form-control form-control-modern" placeholder="Provider Name">
                          </div>
                          <div class="col-6 col-md-8">
                              <input type="url" name="provider_url[]" class="form-control form-control-modern" placeholder="https://example.com/download">
                          </div>
                          <div class="col-2 col-md-1">
                              <button type="button" class="btn remove-link-btn" disabled title="Default Row"><i class="fas fa-trash"></i></button>
                          </div>
                      </div>
                  </div>
              </div>
              
              <button type="button" class="btn add-link-btn-modern mt-2" id="add-link-btn">
                  <i class="fas fa-plus-circle me-2"></i> Add Another Download Link
              </button>
          </div>

          <script>
            document.addEventListener('DOMContentLoaded', function() {
                const modePlay = document.getElementById('mode_play');
                const modeDownload = document.getElementById('mode_download');
                const downloadSection = document.getElementById('download-config-section');
                const linksContainer = document.getElementById('links-container');
                const addLinkBtn = document.getElementById('add-link-btn');
                const githubInput = document.getElementById('github_url');

                function toggleMode() {
                    if (modeDownload.checked) {
                        downloadSection.style.display = 'block';
                        // GitHub optional
                        githubInput.required = false; 
                    } else {
                        downloadSection.style.display = 'none';
                        // GitHub theoretically required for Play mode, but logic is flexible now.
                        // Let's keep it optional but encourage input.
                    }
                }

                modePlay.addEventListener('change', toggleMode);
                modeDownload.addEventListener('change', toggleMode);

                // Add Link Logic
                addLinkBtn.addEventListener('click', function() {
                    const row = document.createElement('div');
                    row.className = 'row link-row g-2 align-items-center slide-in-bottom';
                    row.innerHTML = `
                      <div class="col-4 col-md-3">
                          <input type="text" name="provider_name[]" class="form-control form-control-modern" placeholder="Provider Name">
                      </div>
                      <div class="col-6 col-md-8">
                          <input type="url" name="provider_url[]" class="form-control form-control-modern" placeholder="https://example.com/download">
                      </div>
                      <div class="col-2 col-md-1">
                          <button type="button" class="btn remove-link-btn"><i class="fas fa-times"></i></button>
                      </div>
                    `;
                    linksContainer.appendChild(row);
                    
                    row.querySelector('.remove-link-btn').addEventListener('click', function() {
                        row.remove();
                    });
                });
            });
          </script>

          <!-- Price Model Section -->
          <div class="mb-3">
            <label class="form-label">
                <i class="fas fa-tag"></i> Price Model *
            </label>
            <div class="d-flex gap-4">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="price_type" id="price_free" value="free" checked>
                    <label class="form-check-label text-white" for="price_free">
                        Free
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="price_type" id="price_pro" value="paid">
                    <label class="form-check-label text-white" for="price_pro">
                        Pro (Paid)
                    </label>
                </div>
            </div>
          </div>

          <div class="mb-3" id="price-input-container" style="display: none;">
            <label for="price" class="form-label">
                <i class="fas fa-money-bill"></i> Price (IDR) *
            </label>
            <div class="input-group">
                <span class="input-group-text">Rp</span>
                <input type="number" class="form-control" id="price" name="price" min="1000" placeholder="e.g. 50000">
            </div>
            <small class="text-white">Minimum Rp 1.000</small>
          </div>

          <script>
            // Simple script to toggle price input
            document.addEventListener('DOMContentLoaded', function() {
                const priceFree = document.getElementById('price_free');
                const pricePro = document.getElementById('price_pro');
                const priceContainer = document.getElementById('price-input-container');
                const priceInput = document.getElementById('price');

                function togglePrice() {
                    if (pricePro.checked) {
                        priceContainer.style.display = 'block';
                        priceInput.required = true;
                    } else {
                        priceContainer.style.display = 'none';
                        priceInput.required = false;
                        priceInput.value = '';
                    }
                }

                priceFree.addEventListener('change', togglePrice);
                pricePro.addEventListener('change', togglePrice);
            });
          </script>


          <div class="mb-3">
            <label for="thumbnail" class="form-label">
                <i class="fas fa-image"></i> Thumbnail (Image)
            </label>
            <input type="file" class="form-control" id="thumbnail" name="thumbnail" accept="image/*">
            <div class="mt-2">
                <img id="thumbnail-preview" src="" alt="Preview" style="max-height: 150px; border-radius: 5px; display: none;">
            </div>
            <small class="text-white">Or enter URL below</small>
            <input type="url" class="form-control mt-2" id="thumbnail_url" name="thumbnail_url" placeholder="https://example.com/image.jpg">
          </div>

          <!-- [NEW] Icon Upload Section -->
          <div class="mb-3">
            <label for="icon" class="form-label">
                <i class="fas fa-icons"></i> Game Icon (Square 1:1)
            </label>
            <input type="file" class="form-control" id="icon" name="icon" accept="image/*">
            <div class="mt-2">
                <img id="icon-preview" src="" alt="Icon Preview" style="width: 80px; height: 80px; border-radius: 12px; object-fit: cover; display: none;">
            </div>
            <small class="text-white">Recommended for new Homepage design</small>
          </div>

          <div class="mb-3">
            <label for="video" class="form-label">
                <i class="fas fa-video"></i> Game Video/Trailer
            </label>
            <input type="file" class="form-control" id="video" name="video" accept="video/*">
            <small class="text-white">Or enter URL below (YouTube embed, etc.)</small>
            <input type="url" class="form-control mt-2" id="video_url" name="video_url" placeholder="https://www.youtube.com/embed/...">
          </div>



          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="fas fa-tag"></i> Categories *
              </label>
              <div class="multi-input-container">
                  <div class="input-group mb-2">
                      <input type="text" class="form-control" list="categories_list" placeholder="Add category...">
                      <button type="button" class="btn btn-outline-aqua add-btn"><i class="fas fa-plus"></i></button>
                  </div>
                  <datalist id="categories_list">
                      <% categories.forEach(cat => { %>
                          <option value="<%= cat %>">
                      <% }); %>
                  </datalist>
                  <div class="selected-items d-flex flex-wrap"></div>
                  <input type="hidden" name="category" required>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="fas fa-tags"></i> Tags (Optional)
              </label>
              <div class="multi-input-container">
                  <div class="input-group mb-2">
                      <input type="text" class="form-control" placeholder="Add tag...">
                      <button type="button" class="btn btn-outline-aqua add-btn"><i class="fas fa-plus"></i></button>
                  </div>
                  <div class="selected-items d-flex flex-wrap"></div>
                  <input type="hidden" name="tags">
              </div>
              <small class="text-white">Press Enter or + to add</small>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Auto-Detection:</strong> Game type (playable/download) will
            be automatically detected based on your GitHub URL.
          </div>

          <div class="d-grid gap-2">
            <!-- Progress Bar -->
            <div id="progress-container" class="mb-3" style="display: none;">
                <div class="d-flex justify-content-between text-white mb-1">
                    <span>Uploading...</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div id="progress-bar" class="progress-bar bg-aqua" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>

            <button type="submit" class="btn btn-aqua btn-lg">
              <i class="fas fa-upload"></i> Upload Game
            </button>
            <a href="/games" class="btn btn-outline-aqua">
              <i class="fas fa-times"></i> Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include('../layouts/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function setupMutualExclusion(fileInputId, urlInputId, typeName) {
            const fileInput = document.getElementById(fileInputId);
            const urlInput = document.getElementById(urlInputId);

            if (!fileInput || !urlInput) return;

            // When file is selected
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    // File selected
                    if (urlInput.value.trim() !== "") {
                        if (confirm(`Uploading a ${typeName} file will clear the ${typeName} URL. Do you want to continue?`)) {
                            urlInput.value = "";
                            urlInput.readOnly = true;
                            urlInput.classList.add('bg-dark', 'text-white'); // Visual cue
                        } else {
                            this.value = ""; // Clear file input
                        }
                    } else {
                        urlInput.readOnly = true;
                        urlInput.classList.add('bg-dark', 'text-white');
                    }
                } else {
                    // File deselected/cancelled
                    urlInput.readOnly = false;
                    urlInput.classList.remove('bg-dark', 'text-white');
                }
            });

            // When URL input is clicked while readonly
            urlInput.addEventListener('click', function() {
                if (this.readOnly) {
                    if (confirm(`Do you want to remove the uploaded ${typeName} file and use a URL instead?`)) {
                        fileInput.value = ""; // Clear file input
                        this.readOnly = false;
                        this.classList.remove('bg-dark', 'text-white');
                        this.focus();
                    }
                }
            });
        }

        setupMutualExclusion('thumbnail', 'thumbnail_url', 'Thumbnail');
        setupMutualExclusion('video', 'video_url', 'Video');
    });
</script>
<script src="/js/upload-handler.js"></script>
<script src="/js/multi-input.js"></script>
