<%- include('../layouts/header', { title: title }) %>
<%- include('../partials/navbar') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="form-card">
        <div class="text-center mb-4">
          <i class="fas fa-upload fa-3x text-aqua"></i>
          <h2 class="mt-3">Upload Your Game</h2>
          <p class="text-white">Share your game with the community</p>
        </div>

        <form action="/games" method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="title" class="form-label">
              <i class="fas fa-heading"></i> Game Title *
            </label>
            <input
              type="text"
              class="form-control"
              id="title"
              name="title"
              required
              minlength="3"
              maxlength="255"
            />
            <small class="text-white">Enter a catchy title for your game</small>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">
              <i class="fas fa-align-left"></i> Description *
            </label>
            <textarea
              class="form-control"
              id="description"
              name="description"
              rows="5"
              required
              minlength="50"
            ></textarea>
            <small class="text-white"
              >Minimum 50 characters. Describe your game, gameplay, controls,
              etc.</small
            >
          </div>

          <div class="mb-3">
            <label for="github_url" class="form-label">
              <i class="fab fa-github"></i> GitHub URL *
            </label>
            <input
              type="url"
              class="form-control"
              id="github_url"
              name="github_url"
              required
              placeholder="https://github.com/username/repo"
            />
            <small class="text-white">
              For playable games: Link to repo with index.html<br />
              For downloads: Link to releases page or .zip file
            </small>
          </div>

          <div class="mb-3">
            <label for="thumbnail" class="form-label">
                <i class="fas fa-image"></i> Thumbnail (Image)
            </label>
            <input type="file" class="form-control" id="thumbnail" name="thumbnail" accept="image/*">
            <small class="text-white">Or enter URL below</small>
            <input type="url" class="form-control mt-2" id="thumbnail_url" name="thumbnail_url" placeholder="https://example.com/image.jpg">
          </div>

          <div class="mb-3">
            <label for="video" class="form-label">
                <i class="fas fa-video"></i> Game Video/Trailer
            </label>
            <input type="file" class="form-control" id="video" name="video" accept="video/*">
            <small class="text-white">Or enter URL below (YouTube embed, etc.)</small>
            <input type="url" class="form-control mt-2" id="video_url" name="video_url" placeholder="https://www.youtube.com/embed/...">
          </div>

          <div class="mb-3">
            <label class="form-label">
                <i class="fas fa-tag"></i> Pricing Model *
            </label>
            <div class="d-flex gap-3">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="price_model" id="price_free" value="Free" checked>
                    <label class="form-check-label text-white" for="price_free">
                        Free
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="price_model" id="price_pro" value="Pro">
                    <label class="form-check-label text-white" for="price_pro">
                        Pro
                    </label>
                </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="category" class="form-label">
                <i class="fas fa-tag"></i> Category *
              </label>
              <select
                class="form-control"
                id="category"
                name="category"
                required
              >
                <option value="">Select Category</option>
                <% categories.forEach(cat => { %>
                <option value="<%= cat %>"><%= cat %></option>
                <% }); %>
              </select>
              <input type="text" class="form-control mt-2" id="new_category" name="new_category" placeholder="Or type new category...">
            </div>

            <div class="col-md-6 mb-3">
              <label for="tags" class="form-label">
                <i class="fas fa-tags"></i> Tags (Optional)
              </label>
              <input
                type="text"
                class="form-control"
                id="tags"
                name="tags"
                placeholder="2D, Multiplayer, Retro"
              />
              <small class="text-white">Comma-separated tags</small>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Auto-Detection:</strong> Game type (playable/download) will
            be automatically detected based on your GitHub URL.
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-aqua btn-lg">
              <i class="fas fa-upload"></i> Upload Game
            </button>
            <a href="/games" class="btn btn-outline-aqua">
              <i class="fas fa-times"></i> Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include('../layouts/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function setupMutualExclusion(fileInputId, urlInputId, typeName) {
            const fileInput = document.getElementById(fileInputId);
            const urlInput = document.getElementById(urlInputId);

            if (!fileInput || !urlInput) return;

            // When file is selected
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    // File selected
                    if (urlInput.value.trim() !== "") {
                        if (confirm(`Uploading a ${typeName} file will clear the ${typeName} URL. Do you want to continue?`)) {
                            urlInput.value = "";
                            urlInput.readOnly = true;
                            urlInput.classList.add('bg-dark', 'text-muted'); // Visual cue
                        } else {
                            this.value = ""; // Clear file input
                        }
                    } else {
                        urlInput.readOnly = true;
                        urlInput.classList.add('bg-dark', 'text-muted');
                    }
                } else {
                    // File deselected/cancelled
                    urlInput.readOnly = false;
                    urlInput.classList.remove('bg-dark', 'text-muted');
                }
            });

            // When URL input is clicked while readonly
            urlInput.addEventListener('click', function() {
                if (this.readOnly) {
                    if (confirm(`Do you want to remove the uploaded ${typeName} file and use a URL instead?`)) {
                        fileInput.value = ""; // Clear file input
                        this.readOnly = false;
                        this.classList.remove('bg-dark', 'text-muted');
                        this.focus();
                    }
                }
            });
        }

        setupMutualExclusion('thumbnail', 'thumbnail_url', 'Thumbnail');
        setupMutualExclusion('video', 'video_url', 'Video');
    });
</script>
